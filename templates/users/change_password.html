{% extends 'base.html' %}
{% load static %}

{% block title %}Changer le mot de passe - Kimi Escrow{% endblock %}

{% block extra_css %}
<style>
    .password-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 2rem 0;
    }
    
    .password-card {
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border-radius: 1rem;
    }
    
    .password-header {
        background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%);
        color: white;
        text-align: center;
        padding: 2rem;
        border-radius: 1rem 1rem 0 0;
    }
    
    .password-icon {
        width: 64px;
        height: 64px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 2rem;
    }
    
    .password-strength {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
        margin-top: 0.5rem;
        overflow: hidden;
    }
    
    .password-strength-bar {
        height: 100%;
        transition: all 0.3s ease;
        border-radius: 4px;
    }
    
    .password-strength.weak .password-strength-bar {
        width: 25%;
        background-color: #dc3545;
    }
    
    .password-strength.fair .password-strength-bar {
        width: 50%;
        background-color: #fd7e14;
    }
    
    .password-strength.good .password-strength-bar {
        width: 75%;
        background-color: #ffc107;
    }
    
    .password-strength.strong .password-strength-bar {
        width: 100%;
        background-color: #28a745;
    }
    
    .password-requirements {
        font-size: 0.875rem;
    }
    
    .requirement {
        transition: all 0.3s ease;
    }
    
    .requirement.met {
        color: #28a745;
    }
    
    .requirement.unmet {
        color: #6c757d;
    }
    
    .password-toggle {
        cursor: pointer;
        color: #6c757d;
        transition: color 0.2s ease;
    }
    
    .password-toggle:hover {
        color: #007bff;
    }
    
    .input-group-text {
        border-left: none;
        background: transparent;
    }
    
    .form-control {
        border-right: none;
    }
    
    .form-control:focus {
        border-right: none;
        box-shadow: none;
    }
    
    .form-control:focus + .input-group-text {
        border-color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="password-container">
        <div class="card password-card">
            <div class="password-header">
                <div class="password-icon">
                    <i class="bi bi-shield-lock"></i>
                </div>
                <h4 class="mb-2">Changer le mot de passe</h4>
                <p class="mb-0 opacity-75">
                    Prot√©gez votre compte avec un mot de passe s√©curis√©
                </p>
            </div>
            
            <div class="card-body p-4">
                <form method="post" class="needs-validation" novalidate id="passwordForm">
                    {% csrf_token %}
                    
                    <!-- Mot de passe actuel -->
                    <div class="mb-4">
                        <label for="{{ form.old_password.id_for_label }}" class="form-label">
                            {{ form.old_password.label }}
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   class="form-control" 
                                   id="{{ form.old_password.id_for_label }}"
                                   name="{{ form.old_password.name }}"
                                   placeholder="Entrez votre mot de passe actuel"
                                   required>
                            <span class="input-group-text">
                                <i class="bi bi-eye password-toggle" onclick="togglePassword('{{ form.old_password.id_for_label }}')"></i>
                            </span>
                        </div>
                        {% if form.old_password.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.old_password.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Nouveau mot de passe -->
                    <div class="mb-3">
                        <label for="{{ form.new_password.id_for_label }}" class="form-label">
                            {{ form.new_password.label }}
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   class="form-control" 
                                   id="{{ form.new_password.id_for_label }}"
                                   name="{{ form.new_password.name }}"
                                   placeholder="Nouveau mot de passe s√©curis√©"
                                   required>
                            <span class="input-group-text">
                                <i class="bi bi-eye password-toggle" onclick="togglePassword('{{ form.new_password.id_for_label }}')"></i>
                            </span>
                        </div>
                        {% if form.new_password.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.new_password.errors.0 }}
                            </div>
                        {% endif %}
                        
                        <!-- Indicateur de force -->
                        <div class="password-strength mt-2" id="passwordStrength">
                            <div class="password-strength-bar"></div>
                        </div>
                        <div class="form-text" id="strengthText">Force du mot de passe</div>
                    </div>
                    
                    <!-- Confirmation du mot de passe -->
                    <div class="mb-4">
                        <label for="{{ form.confirm_password.id_for_label }}" class="form-label">
                            {{ form.confirm_password.label }}
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   class="form-control" 
                                   id="{{ form.confirm_password.id_for_label }}"
                                   name="{{ form.confirm_password.name }}"
                                   placeholder="R√©p√©tez le nouveau mot de passe"
                                   required>
                            <span class="input-group-text">
                                <i class="bi bi-eye password-toggle" onclick="togglePassword('{{ form.confirm_password.id_for_label }}')"></i>
                            </span>
                        </div>
                        {% if form.confirm_password.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.confirm_password.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="invalid-feedback" id="passwordMismatch" style="display: none;">
                            Les mots de passe ne correspondent pas
                        </div>
                    </div>
                    
                    <!-- Exigences du mot de passe -->
                    <div class="card bg-light mb-4">
                        <div class="card-body py-3">
                            <h6 class="card-title mb-2">
                                <i class="bi bi-info-circle text-info me-1"></i>
                                Exigences du mot de passe
                            </h6>
                            <div class="password-requirements">
                                <div class="requirement unmet" id="req-length">
                                    <i class="bi bi-circle me-2"></i>
                                    Au moins 8 caract√®res
                                </div>
                                <div class="requirement unmet" id="req-uppercase">
                                    <i class="bi bi-circle me-2"></i>
                                    Au moins une majuscule (A-Z)
                                </div>
                                <div class="requirement unmet" id="req-lowercase">
                                    <i class="bi bi-circle me-2"></i>
                                    Au moins une minuscule (a-z)
                                </div>
                                <div class="requirement unmet" id="req-number">
                                    <i class="bi bi-circle me-2"></i>
                                    Au moins un chiffre (0-9)
                                </div>
                                <div class="requirement unmet" id="req-special">
                                    <i class="bi bi-circle me-2"></i>
                                    Au moins un caract√®re sp√©cial (!@#$%^&*)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Boutons -->
                    <div class="d-flex gap-3">
                        <button type="submit" class="btn btn-primary btn-lg flex-grow-1" id="submitBtn" disabled>
                            <i class="bi bi-shield-check me-2"></i>
                            Changer le mot de passe
                        </button>
                        <a href="{% url 'profile' %}" class="btn btn-outline-secondary btn-lg">
                            Annuler
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Conseils de s√©curit√© -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="bi bi-lightbulb text-warning me-2"></i>
                    Conseils de s√©curit√©
                </h6>
                <ul class="list-unstyled mb-0 small">
                    <li class="mb-2">üîê Utilisez un mot de passe unique pour chaque compte</li>
                    <li class="mb-2">üé≤ Combinez lettres, chiffres et symboles</li>
                    <li class="mb-2">üì± Activez l'authentification √† deux facteurs</li>
                    <li class="mb-2">üîÑ Changez votre mot de passe r√©guli√®rement</li>
                    <li class="mb-0">üö´ Ne partagez jamais votre mot de passe</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('passwordForm');
    const newPasswordInput = document.getElementById('{{ form.new_password.id_for_label }}');
    const confirmPasswordInput = document.getElementById('{{ form.confirm_password.id_for_label }}');
    const submitBtn = document.getElementById('submitBtn');
    
    // Validation en temps r√©el
    newPasswordInput.addEventListener('input', function() {
        validatePassword(this.value);
        checkPasswordMatch();
    });
    
    confirmPasswordInput.addEventListener('input', function() {
        checkPasswordMatch();
    });
    
    // Validation du formulaire
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity() || !isPasswordValid() || !doPasswordsMatch()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
    
    function validatePassword(password) {
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        // Mettre √† jour les exigences visuelles
        Object.keys(requirements).forEach(req => {
            const element = document.getElementById(`req-${req}`);
            const icon = element.querySelector('i');
            
            if (requirements[req]) {
                element.classList.remove('unmet');
                element.classList.add('met');
                icon.className = 'bi bi-check-circle me-2';
            } else {
                element.classList.remove('met');
                element.classList.add('unmet');
                icon.className = 'bi bi-circle me-2';
            }
        });
        
        // Calculer la force du mot de passe
        const score = Object.values(requirements).filter(Boolean).length;
        updatePasswordStrength(score);
        
        // Activer/d√©sactiver le bouton
        updateSubmitButton();
        
        return Object.values(requirements).every(Boolean);
    }
    
    function updatePasswordStrength(score) {
        const strengthIndicator = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('strengthText');
        
        strengthIndicator.className = 'password-strength mt-2';
        
        if (score === 0) {
            strengthText.textContent = 'Force du mot de passe';
        } else if (score <= 2) {
            strengthIndicator.classList.add('weak');
            strengthText.textContent = 'Faible';
            strengthText.className = 'form-text text-danger';
        } else if (score <= 3) {
            strengthIndicator.classList.add('fair');
            strengthText.textContent = 'Moyen';
            strengthText.className = 'form-text text-warning';
        } else if (score <= 4) {
            strengthIndicator.classList.add('good');
            strengthText.textContent = 'Bon';
            strengthText.className = 'form-text text-info';
        } else {
            strengthIndicator.classList.add('strong');
            strengthText.textContent = 'Excellent';
            strengthText.className = 'form-text text-success';
        }
    }
    
    function checkPasswordMatch() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        const mismatchFeedback = document.getElementById('passwordMismatch');
        
        if (confirmPassword && newPassword !== confirmPassword) {
            confirmPasswordInput.classList.add('is-invalid');
            mismatchFeedback.style.display = 'block';
            updateSubmitButton();
            return false;
        } else {
            confirmPasswordInput.classList.remove('is-invalid');
            mismatchFeedback.style.display = 'none';
            updateSubmitButton();
            return true;
        }
    }
    
    function isPasswordValid() {
        const password = newPasswordInput.value;
        return password.length >= 8 && 
               /[A-Z]/.test(password) && 
               /[a-z]/.test(password) && 
               /\d/.test(password) && 
               /[!@#$%^&*(),.?":{}|<>]/.test(password);
    }
    
    function doPasswordsMatch() {
        return newPasswordInput.value === confirmPasswordInput.value;
    }
    
    function updateSubmitButton() {
        const isValid = isPasswordValid() && doPasswordsMatch() && confirmPasswordInput.value;
        submitBtn.disabled = !isValid;
        
        if (isValid) {
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-primary');
        } else {
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-secondary');
        }
    }
});

function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.nextElementSibling.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'bi bi-eye-slash password-toggle';
    } else {
        input.type = 'password';
        icon.className = 'bi bi-eye password-toggle';
    }
}

// G√©n√©rateur de mot de passe (bonus)
function generateSecurePassword() {
    const length = 12;
    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
    let password = "";
    
    // S'assurer qu'on a au moins un caract√®re de chaque type
    password += "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random() * 26)];
    password += "abcdefghijklmnopqrstuvwxyz"[Math.floor(Math.random() * 26)];
    password += "0123456789"[Math.floor(Math.random() * 10)];
    password += "!@#$%^&*"[Math.floor(Math.random() * 8)];
    
    // Compl√©ter avec des caract√®res al√©atoires
    for (let i = 4; i < length; i++) {
        password += charset[Math.floor(Math.random() * charset.length)];
    }
    
    // M√©langer le mot de passe
    return password.split('').sort(() => 0.5 - Math.random()).join('');
}
</script>
{% endblock %}
